#cloud-config
# Keep an extra new line with no spaces for merging files together

write_files:
  # conf.json
  - content: |
      { 
          "--block-disk": "/dev/sdb",
          "--cust-yaml": "/tmp/psft_customizations.yaml",
          "--dpk-platform": "linux",
          "--dpk-source": "CM",
          "--dpk-type": "FSCM",
          "--export": "/psftcm.mgmt.new.oraclevcn.com-export",
          "--mount-path": "/cm_psft_dpks",
          "--nfs-host": "10.10.1.4",
          "--verbose": true
      }
    path: /u01/app/ioco/conf.json
  # psft_customization.yaml
  - content: |
      ---
      # defaults generated by ioco
      dpk_location:     /u01/app/oracle/product/dpk
      user_home_dir:    /home
      ps_config_home:   /u01/app/oracle/product/hostname/ps_cfg_home
                      
    path: /tmp/psft_customizations.yaml
  # sudoers.d
  - content: |      
      Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
    path: /etc/sudoers.d/secure-path

runcmd:
  - [ sh, -c, 'yum install -y git python-oci-cli' ]
  # setup iscsi block
  - [ sh, -c, 'systemctl enable ocid.service' ]
  - [ sh, -c, 'systemctl start ocid.service' ]
  - [ sh, -c, 'systemctl status ocid.service' ]
  # manual install python dependencies until published in pip
  - [ sh, -c, 'sudo python3 -m pip install docopt requests' ]
  # we have our repo private in github, so hosting internal on gitlab that doesn't have ssl working right 
  - [ sh, -c, 'sudo git config --global http.sslVerify false' ]
  - [ sh, -c, 'sudo git clone https://test.mgmt.new.oraclevcn.com/root/iocloudops.git /tmp/ioCloudOps' ]
  # local install until it is published
  - [ sh, -c, 'sudo python3 -m pip install /tmp/ioCloudOps' ]
