#cloud-config
# Keep an extra new line with no spaces for merging files together

write_files:
  # conf.json
  - content: |
      { 
          "--dpk-patch": "03",          
          "--dpk-platform": "linux",    
          "--dpk-source": "CM",         
          "--dpk-type": "tools",        
          "--dpk-version": "858",   
          "--block-disk": "/dev/sdb",
          "db_host": "fulltier",        
          "opr_id": "VP1",              
          "opr_pwd": "VP1",   
          "--export": "/psftcm.mgmt.new.oraclevcn.com-export",
          "--mount-path": "/cm_psft_dpks",
          "--nfs-host": "10.10.1.4"
      }
    path: /u01/app/ioco/conf.json
  # psft_customization.yaml
  - content: |
      ---
      # defaults generated by ioco
      dpk_location:     /u01/app/oracle/product/dpk
      user_home_dir:    /home
      ps_config_home:   /u01/app/oracle/product/hostname/ps_cfg_home
                      
    path: /tmp/psft_customizations.yaml
  # sudoers.d
  - content: |      
      Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
    path: /etc/sudoers.d/secure-path

runcmd:
  - [ sh, -c, 'yum install -y git python-oci-cli tree' ]
  - [ sh, -c, 'systemctl disable firewalld' ]
  - [ sh, -c, 'systemctl stop firewalld' ]
  # setup iscsi block
  - [ sh, -c, 'systemctl enable ocid.service' ]
  - [ sh, -c, 'systemctl start ocid.service' ]
  - [ sh, -c, 'systemctl status ocid.service' ]
  # local install until it is published
  - [ sh, -c, 'sudo git clone https://github.com/psadmin-io/ioco.git /tmp/ioCloudOps' ]
  - [ sh, -c, 'sudo python3 -m pip install /tmp/ioCloudOps' ]
  - [ sh, -c, 'sudo ioco oci block --make-file-system --mount --block-disk=/dev/sdb' ]
  - [ sh, -c, 'sudo ioco cm attach-dpk-files --nfs-host=10.10.1.4 --export=/psftcm.mgmt.new.oraclevcn.com-export' ]
  - [ sh, -c, 'sudo ioco dpk deploy' ]
